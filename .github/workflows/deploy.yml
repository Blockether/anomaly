name: Deploy to Clojars

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: DeLaGuardo/setup-clojure@13.1
        with:
          cli: latest

      - name: Cache Clojure deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure/.cpcache
          key: clojars-deploy-${{ hashFiles('deps.edn') }}

      - name: Build & Deploy to Clojars
        env:
          VERSION: ${{ github.ref_name }}
          CLOJARS_USERNAME: blockether-deployer
          CLOJARS_PASSWORD: ${{ secrets.CLOJARS_DEPLOY_TOKEN }}
        run: clojure -T:build deploy

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | head -n 2 | tail -n 1)
          CURRENT_TAG=${{ github.ref_name }}

          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "$CURRENT_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $CURRENT_TAG)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..${CURRENT_TAG})
          fi

          echo "## What's Changed" > /tmp/release_body.md
          echo "" >> /tmp/release_body.md
          echo "$CHANGELOG" >> /tmp/release_body.md
          echo "" >> /tmp/release_body.md
          echo "**Full Changelog**: https://github.com/Blockether/anomaly/compare/${PREV_TAG}...${CURRENT_TAG}" >> /tmp/release_body.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --notes-file /tmp/release_body.md
